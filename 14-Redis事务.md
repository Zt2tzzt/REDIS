# Redis 事务

Redis 支持事务，也就是说可以在一次请求中，执行多个命令。

Redis 中的事务，主要是用过 MULTI 和 EXEC 这两个命令来实现的。

MULTI 命令，用来开启一个事务，事务开启之后，所有的命令就会被放入到一个队列中。再通过 EXEC 命令来执行。

- 在收到 EXEC 命令之前，所有的命令，都会放入一个队列中缓存起来，不会立即执行。
- 在收到 EXEC 命令之后，事务开始执行。事务中任何一个命令执行失败，其他命令依然会被执行。
- 在事务执行的过程中，其它客户端提交的命令请求，并不会被插入到事务的执行命令序列中。

在关系型数据库中，事务一般是一个原子操作，要么全部执行成功，要么全部执行失败。

在 Redis 中，事务不会保证所有命令都会执行成功，它的执行结果，取决于事务中的命令。

![Redis事务](NodeAssets/Redis事务.jpg)

## 一、MULTI 命令

使用 MULTI 命令，开启一个事务。

```bash
127.0.0.1:6379> MULTI
OK
127.0.0.1:6379(TX)> 
```

- `TX`，表示进入了事务模式。

在事务中执行一些命令：

```bash
127.0.0.1:6379(TX)> SET k1 v1
QUEUED
127.0.0.1:6379(TX)> SET k2 v2
QUEUED
```

- 此时，命令没有被执行，只是被放入到了队列中。`QUEUED`，表示命令已被放入到队列中。

## 二、EXEC 命令

使用 EXEC 命令，来执行事务中的命令：

```bash
127.0.0.1:6379(TX)> EXEC
1) OK
2) OK
```

获取 k1，k2 的值：

```bash
127.0.0.1:6379> GET k1
"v1"
127.0.0.1:6379> GET k2
"v2"
```

## 三、事务不会保证所有命令执行成功

先来设置一些值，其中 k3，k5 是数字，k4 是字符串：

```bash
127.0.0.1:6379> SET k3 3
OK
127.0.0.1:6379> SET k4 v4
OK
127.0.0.1:6379> SET k5 5
OK
```

打开一个事务：

```basic
127.0.0.1:6379> MULTI
OK
127.0.0.1:6379(TX)> 
```

在事务中，加入一些命令：

```bash
127.0.0.1:6379(TX)> INCR k3
QUEUED
127.0.0.1:6379(TX)> INCR k4
QUEUED
127.0.0.1:6379(TX)> INCR k5
QUEUED
```

使用 EXEC 命令，执行事务中的命令

```bash
127.0.0.1:6379(TX)> EXEC
1) (integer) 4
2) (error) ERR value is not an integer or out of range
3) (integer) 6
```

在事务执行的过程中，某一个命令执行失败，它后面的命令依然会被执行。