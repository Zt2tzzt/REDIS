# Redis 哨兵模式

上文搭建了一主一从的 Redis 集群。

但这种模式还是有问题，如果主节点宕机了，还需要手工把另一台从节点，提升为主节点。这样就不能实现真正的高可用。

要实现自动的故障转移，就要使用哨兵模式。

哨兵会以一个独立的进程，运行在 Redis 集群中，用来监控 Redis 中的各个节点，是否正常运行。它主要有如下功能：

- 监控，通过不断的发送命令，来检查 Redis 节点是否正常。
- 通知，如果发现某个节点出了问题，那么哨兵就会通过”发布订阅“模式，来通知其他节点。
- 自动故障转移，当主节点不能正常工作的时候，哨兵会开始一个自动故障转移的操作，将一个从节点，升级为新的主节点，然后再将其它从节点，指向新的主节点。

配置哨兵模式，在 Redis 集群中，添加一个哨兵节点，可以使用 redis-sentinel 命令，来启动哨兵节点。

使用 vim，添加一个配置文件 sentinel.conf

```shell
vim sentinel.conf
```

在其中进行如下配置：

```shell
sentinel monitor master 127.0.0.1 6379 1
```

- `master`，主节点的名称。
- `1`，表示只需要一个哨兵节点同意，就可以进行故障转移了。

没有 redis-sentinel 服务的，先安装该服务

```shell
apt install redis-sentinel
```

接下来，启动哨兵节点。

```shell
redis-sentinel sentinel.conf
```

```text
           _.-``__ ''-._
      _.-``    `.  `_.  ''-._           Redis 7.2.4 (00000000/0) 64 bit
  .-`` .-```.  ```\/    _.,_ ''-._
 (    '      ,       .-`  | `,    )     Running in sentinel mode
 |`-._`-...-` __...-.``-._|'` _.-'|     Port: 26379
 |    `-._   `._    /     _.-'    |     PID: 331654
  `-._    `-._  `-./  _.-'    _.-'
 |`-._`-._    `-.__.-'    _.-'_.-'|
 |    `-._`-._        _.-'_.-'    |           https://redis.io
  `-._    `-._`-.__.-'_.-'    _.-'
 |`-._`-._    `-.__.-'    _.-'_.-'|
 |    `-._`-._        _.-'_.-'    |
  `-._    `-._`-.__.-'_.-'    _.-'
      `-._    `-.__.-'    _.-'
          `-._        _.-'
              `-.__.-'
```

- 发现哨兵节点运行在 26379 端口。

关闭 Redis 主节点，来模拟宕机的情况。

```shell
systemctl stop redis
```

在从节点中，查看角色是否变成了主节点。

```shell
info replication
```

哨兵本身也是一个进程，它自己也会有单节点故障的问题。

所以在实际的生产环境中，一般会使用三个哨兵节点，来保证高可用。这三个哨兵会通过选举的方式，选出一个领导者，然后由领导者来监控其他节点。

如果领导者挂了，那么其它哨兵节点，会重新选举出一个领导者。这样姐可以保证哨兵节点的高可用了。
